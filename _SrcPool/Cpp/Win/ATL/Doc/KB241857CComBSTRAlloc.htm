<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>The CComBSTR constructor does not always allocate sufficient space in ATL
</title>
</head>

<body>
<h1 class="title">The CComBSTR constructor does not always allocate sufficient 
space in ATL</h1>
<p>This article was previously published under Q241857</p>
<p>Article ID:241857 Last Review: June 2, 2005 Revision:3.0</p>
<h2 class="subTitle" id="tocHeadRef">SYMPTOMS</h2>
<div class="sbody">
  The following fragment of code produces different results with ATL version 2.1 
  and ATL version 3.0:
  <pre class="code">char rawStr[128] = &quot;01234567839&quot;;
CComBSTR bstr (4, rawStr);
				</pre>
  <p>In ATL 2.1, the new <b>bstr</b> is L&quot;0123&quot;; however, in ATL 3.0, the new <b>
  bstr</b> is L&quot;012&quot;.</div>
<h2 class="subTitle" id="tocHeadRef">CAUSE</h2>
<div class="sbody">
  This problem is due to a bug in the <b>A2WBSTR</b> function in the Atlconv.h 
  file:
  <pre class="code">inline BSTR A2WBSTR(LPCSTR lp, int nLen = -1)
{
 USES_CONVERSION;
 BSTR str = NULL;
 int nConvertedLen= MultiByteToWideChar(_acp, 0, lp, nLen, NULL, NULL)-1;
 str = ::SysAllocStringLen(NULL, nConvertedLen);
 if (str != NULL)
 {
  MultiByteToWideChar(_acp, 0, lp, -1,
   str, nConvertedLen);
 }
 return str;
}
				</pre>
  <p>If the <b>MultiByteToWideChar</b> function's fourth argument is -1, the 
  string is assumed to be NULL-terminated and the number of bytes returned will 
  include the NULL character. The result of this function should not subtract 1 
  (one) if nLen does not equal -1; it should only do this if nLen is equal to 
  -1.</div>
<h2 class="subTitle" id="tocHeadRef">RESOLUTION</h2>
<div class="sbody">
  There are two ways to correct this problem:
  <h4 id="tocHeadRef">Method 1</h4>
  <p>Use one of the conversion macros to wrap the string passed into the 
  constructor: </p>
  <pre class="code">CComBSTR bstr(5, T2OLE(buf));</pre>
  <div class="indent">
    -or-
  </div>
  <pre class="code">CComBSTR bstr(5, OLESTR(&quot;01234&quot;);</pre>
  <p>This method uses the <b>CComBSTR(int nSize, LPCOLESTR sz)</b> constructor, 
  which calls <b>::SysAllocStringLen</b>, and then returns a <b>BSTR</b> with 
  the number of characters equal to nSize. </p>
  <h4 id="tocHeadRef">Method 2</h4>
  <p>Change the incorrect code in Atlconv.h for the <b>A2WBSTR</b> function: </p>
  <table class="list ol">
    <tr>
      <td class="number" valign="top">1.</td>
      <td class="text">Change the code in Atlconv.h for the <b>A2WBSTR</b> 
      function from the following:
      <pre class="code">inline BSTR A2WBSTR(LPCSTR lp, int nLen = -1)
{
  USES_CONVERSION;
  BSTR str = NULL;
  int nConvertedLen = MultiByteToWideChar(_acp, 0, lp, nLen, NULL, NULL)-1;
  str = ::SysAllocStringLen(NULL, nConvertedLen);
  if (str != NULL)
  {
    MultiByteToWideChar(_acp, 0, lp, -1, str, nConvertedLen);
  }
  return str;
}
						</pre>
      <p>to the following: </p>
      <pre class="code">inline BSTR A2WBSTR(LPCSTR lp, int nLen = -1)
{
   USES_CONVERSION;
   BSTR str = NULL;
   int nConvertedLen = MultiByteToWideChar(_acp, 0, lp,
     nLen, NULL, NULL);
 
   // BUG FIX #1 (from Q241857): only subtract 1 from 
   // the length if the source data is nul-terminated
   if (nLen == -1)
      nConvertedLen--;
 
   str = ::SysAllocStringLen(NULL, nConvertedLen);
   if (str != NULL)
   {
     MultiByteToWideChar(_acp, 0, lp, nLen, str, nConvertedLen);
   }
   return str;
}
						</pre>
      </td>
    </tr>
    <tr>
      <td class="number" valign="top">2.</td>
      <td class="text">Save Atlconv.h.</td>
    </tr>
    <tr>
      <td class="number" valign="top">3.</td>
      <td class="text">On the <b>Build</b> menu, click <b>Rebuild All</b>. You 
      need to do this on a Debug or ReleaseMinDependency build so that the 
      modified code above is linked into your code.</td>
    </tr>
  </table>
</div>
<h2 class="subTitle" id="tocHeadRef">STATUS</h2>
<div class="sbody">
  Microsoft has confirmed that this is a bug in the Microsoft products that are 
  listed in the &quot;Applies to&quot; section.</div>
<h5>APPLIES TO</h5>
<table class="list">
  <tr>
    <td class="bullet">•</td>
    <td class="text">Microsoft ActiveX Template Library 3.0, when used with:</td>
  </tr>
  <tr>
    <td class="textSub" colspan="2"><table class="list">
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text">Microsoft Visual C++ 6.0 Enterprise Edition</td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text">Microsoft Visual C++ 6.0 Professional Edition</td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text">Microsoft Visual C++, 32-bit Learning Edition 6.0</td>
      </tr>
    </table>
    </td>
  </tr>
</table>
<h5>Keywords:</h5>
<p>kbtshoot kbbug kbstring KB241857</p>
</body>

</html>