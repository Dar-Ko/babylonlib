<html lang="en-ca">

<!--/* Group=Standards*/ -->

<head>
<meta name="GENERATOR" content="Microsoft FrontPage 5.0" />
<meta name="ProgId" content="FrontPage.Editor.Document" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="en-ca" />
<meta name="Workfile" content="$Workfile: TestComAtlVc7.htm$: documentation" />
<meta name="Revision" content="$Revision: 16$" />
<meta name="robots" content="index" />
<meta name="keywords" content="compiler, ATL, COM" />
<!-- Dublin Core Metadata Package -->
<meta name="DC.title" content="Creating an ATL COM project with Visual Studio .Net 2003 v7.1" />
<meta name="DC.creator" content="Darko Kolaković" />
<meta name="DC.creator.vCard.EMAIL.internet" content="DarkoKolakovic @ yahoo" />
<meta name="DC.Contributor" content="$Author: Darko Kolakovic$" />
<meta name="DC.Rights" content="© CommonSoft Inc" />
<meta name="DC.subject" content="ATL COM" />
<meta name="DC.description.abstract" content="COM project setup" />
<meta name="DC.publisher" content="CommonSoft Incorporated" />
<meta name="DC.date" content="$Date: 2007-07-18 17:14:49$" />
<meta name="DC.type" content="Text.Article" />
<meta name="DC.format" content="application/html" />
<meta name="DC.language" content="en_ca" />
<meta name="DC.identifier.Revision" content="$Revision: 16$" />
<meta name="DC.relation.HasVersion" content="http://babylonlib.cvs.sourceforge.net/babylonlib" />
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
<link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" type="text/css" href="../../../../../Doc/Res/KDocument.css" />
<link rel="icon" href="../../../../../Doc/Res/KBook.ico" type="image/ico" />
<title>Creating an ATL COM project with Visual Studio .Net 2003 v7.1</title>
<base target="_self" />
<style type="text/css">
    dt
      {
      font-weight: bold;
      }
    table
      {
      border-collapse: collapse;
      }
    body
      {
      background-image: url('../../../../../Doc/Res/KBckgGray.jpg');
      }
  </style>
</head>

<body>

<h1>Creating an ATL COM project with Visual Studio .Net 2003 v7.1</h1>
<p>See also: <a href="../TestComAtl/TestComAtlVc6.htm">Creating an </a>
<a href="#Footnote1"><sup class="Footnote">1</sup></a>
<a href="../TestComAtl/TestComAtlVc6.htm">COM</a><a href="#Footnote2">
<sup class="Footnote">2</sup></a><a href="../TestComAtl/TestComAtlVc6.htm"> 
project with Visual C++ 6.0</a>
<img border="0" src="../../../../../Doc/Symbol/extern.gif" width="14" height="22" /></p>
<ol>
  <li>Select new Visual C++ ATL project and choose &quot;ATL Project&quot; template:<br />
  <img border="0" src="Res/ComAtlVc71.gif" width="530" height="144" /></li>
  <li>Type desired project name</li>
  <li>Specify applications settings. If Attributed is checked, the compiler will 
  parse and validate attributes found in a source file. A Service has benefits 
  of running non-interactively immediately after system starts.<br />
&nbsp;<table border="0" cellpadding="0" cellspacing="15" style="border-collapse: collapse" bordercolor="#111111">
    <tr>
      <td><img border="0" src="Res/ComAtlVc72.gif" width="223" height="232" /></td>
      <td style="font-size: 80%">
      <img border="0" src="Res/ComAtlVc72b.gif" align="left" width="189" height="215">Purpose 
      of attributes is to simplify the authoring of COM components by replacing 
      the large amount of IDL code required by a COM component with a few 
      concise attributes. There are attributes that aid in the creation of .idl 
      files, interfaces, type libraries, and other COM elements. In the 
      integrated development environment (IDE), attributes are supported by the 
      wizards and by the Properties window.</td>
    </tr>
    <tr>
      <td class="Caption">.exe COM as a Windows service</td>
      <td class="Caption">.dll COM</td>
    </tr>
  </table>
  <p>Be aware that:
  <ul>
    <li>.exe COM server will run only as a <i>local</i> or <i>remote</i> <i>
    out-of-process</i> server and an additional <i>Proxy/Stub DLL</i> is 
    required</li>
    <li>.dll COM could be either a <i>local in-process</i> or a <i>local</i> or
    <i>remote out-of-process</i> server.</li>
  </ul>
  </li>
  <li>After finishing with the wizard, the result will be displayed in the 
  Solution Explorer:<br />
  <img border="0" src="Res/ComAtlVc73.gif" width="257" height="447" /></li>
  <li>Provide the appropriate security settings for your service by replacing 
  default code in <code>YourAtlModule::InitializeSecurity()</code> with the 
  following:<pre><code>HRESULT InitializeSecurity() <span class="SKeyword">throw()</span>
{
   <span class="Rem">//Allow service access to everyone</span>
 HRESULT hResult =
      CoInitializeSecurity(NULL, <span class="Rem">//points to the access permissions that</span>
                                 <span class="Rem">//a server will use to receive calls</span>
                             -1, <span class="Rem">//count of entries in asAuthSvc</span>
                           NULL, <span class="Rem">//array of authentication services</span>
                           NULL, <span class="Rem">//reserved for future use</span>
                           RPC_C_AUTHN_LEVEL_NONE, <span class="Rem">//default authentication level</span>
                           RPC_C_IMP_LEVEL_IMPERSONATE,<span class="Rem"> //default impersonation</span>
                                                        <span class="Rem">//level for proxies</span>
                           NULL, <span class="Rem">//information for each authentication service</span>
                                 <span class="Rem">//that a client can use to call a server</span>
                           EOAC_NONE, <span class="Rem">//capabilities of the client or server</span>
                           NULL <span class="Rem">//reserved for future use</span>
                          );

 <span class="Skeyword">return</span> hResult;
}</code></pre>
  <p><br />
  </li>
  <li>To add new ATL object in Class View, after right mouse click, select &quot;Add 
  Class&quot;<br />
  <img border="0" src="Res/ComAtlVc74.gif" width="288" height="161" /></li>
  <li>Choose <i>ATL Simple Object</i> from Visual C++ ATL categories:<br />
&nbsp;<table border="0" cellpadding="0" cellspacing="10" style="border-collapse: collapse" bordercolor="#111111">
    <tr>
      <td><img border="0" src="Res/ComAtlVc75.gif" width="240" height="208" /></td>
      <td valign="top" style="font-size: 80%">If it is required to use COM 
      object within an <u>OLE Container</u>, select <a name="ATLControlTemplate">
      <i>ATL Control</i> template</a> to add an ATL <i>ActiveX Control </i>
      (formerly known as custom or OLE controls). Microsoft FrontPage is an
      <a href="Res/ComAtlXVc7L.gif">example</a> of container using ActiveX 
      controls to enhance HTML documents.<p>
      <img border="0" src="Res/ComAtlVc75b.gif" align="left" width="60" height="47">This 
      wizard inserts into an ATL project (or an MFC<a href="#Footnote3"><sup class="Footnote">3</sup></a> 
      project with ATL support) an <i>ATL ActiveX Control</i>. You can use this 
      wizard to insert one of three types of controls: </p>
      <ul type="disc">
        <li>A standard control </li>
        <li>A composite control </li>
        <li>A DHTML control </li>
      </ul>
      <p>Additionally, you can specify a minimal control, removing the 
      interfaces from the Interfaces list, which are provided as defaults for 
      controls to open in most containers. You can set the interfaces you want 
      supported for the control in the <b>Interfaces</b> page of the wizard.</p>
      <p>&nbsp;</td>
    </tr>
  </table>
  </li>
  <li>Insert the name for the object<br />
  <img border="0" src="Res/ComAtlVc76.gif" width="615" height="437" /><br />
  If <i>Attributed</i> is selected, the .idl file will be automatically created 
  by the compiler, based on
  <a href="http://msdn2.microsoft.com/en-us/library/aa367042.aspx" title="IDL Atributes">
  attribute blocks</a> inserted by this wizard.<br />
  </li>
  <li>Also set desired options in the same wizard dialog:<br />
  <img border="0" src="Res/ComAtlVc79.gif" width="506" height="339" /><br />
  If this COM object is not going to be aggregated inside another, select <i>No</i> 
  for Aggregation. For the simplest interface option is <i>Custom</i>. This will 
  add smallest common denominator for COM objects: <i>IUknown</i> interface and 
  virtual functions list <em>vtable</em>. The <tt>IUnknown</tt> interface has 
  the following member functions:<ul>
    <li><tt>ULONG AddRef(void)</tt> </li>
    <li><tt>ULONG Release(void)</tt> </li>
    <li><tt>HRESULT QueryInterface(REFIID id, void **ipv)</tt> </li>
  </ul>
  <p>
  <img border="0" src="../../../../../Doc/Images/diagIConnectionPoint.gif" align="right" width="360" height="140" />However, 
  scripting engines like JavaScript
  <a href="../TestComContainer/Src/TestComContainer.htm" title="Test embedded ActiveX objects">
  <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8"></a> 
  could not access exported methods through the <i>vtable</i> and <i>IDispatch<b>
  </b></i>interface is required. The new interface will be added if <i>Dual </i>
  Interface is selected in the wizard form.<br />
  With <i>Connection points</i> support the COM server will fire events back to 
  the client, with help of another interface - <i>IConnectionPointContainer</i>. 
  Also id required to implement the <b>IProvideClassInfo</b> or <b>
  <a name="IProvideClassInfo2" href="../TestComContainer/scripting_events.htm#IProvideClassInfo2">
  IProvideClassInfo2</a></b> interface, because Internet Explorer relies on 
  those interfaces to obtain type library. <a href="#ATLControlTemplate">ATL 
  Control</a>, Visual Basic and MFC<a href="#Footnote3"><sup class="Footnote">3</sup></a> 
  wizards will add the interfaces by default, but for <i>ATL Simple Object</i><sup><a class="Ref" href="#200839">[Q200839]</a></sup> 
  add following code to the object:<br />
  </p>
  <pre><code> public IProvideClassInfo2Impl&lt;&amp;CLSID_TestAtlObj, NULL,
                                 &amp;LIBID_TestComAtlLib&gt;
   ...
   {
   ...
   COM_INTERFACE_ENTRY(IProvideClassInfo)
   COM_INTERFACE_ENTRY(IProvideClassInfo2)
   ...
   }</code></pre>
  <table border="0" cellpadding="0" cellspacing="5" style="border-collapse: collapse; font-size: 90%" bordercolor="#111111">
    <tr>
      <td width="100%" colspan="2">
      <img border="0" src="Res/ComAtlVc75b.gif" align="left" width="60" height="47"><b><a href="#ATLControlTemplate">ATL 
      Control Wizard</a></b>, in other hand, will add a user interface object 
      that supports interfaces required for all potential containers.</td>
    </tr>
    <tr>
      <td width="50%">
      <img border="0" src="Res/ComAtlVc79b.gif" width="313" height="177"></td>
      <td width="50%">
      <img border="0" src="Res/ComAtlVc79c.gif" width="310" height="154"></td>
    </tr>
    <tr>
      <td width="50%">
      <img border="0" src="Res/ComAtlVc79d.gif" width="256" height="153"></td>
      <td width="50%">&nbsp;</td>
    </tr>
  </table>
  <p>After finishing with options, the result will be presented in the Solution 
  Explorer:<br />
  <img border="0" src="Res/ComAtlVc78.gif" width="228" height="380" /><br />
  The IDL file will contain following snippet:</p>
  <pre><code>  [
    uuid(8CFF83A5-6A5F-4AE7-BDB5-45E8532AC543),
    helpstring(&quot;TestAtl7Obj Class&quot;)
  ]
  coclass <b>TestAtlObj</b>
  {
    [default] interface ITestAtlObj;
    ...
  };</code></pre>
  <p>However, if Visual C++ IDL attributes are used, you will find the next 
  attribute block in the header file (.h): </p>
  <pre><code>[
  coclass,
  threading(&quot;apartment&quot;),
  support_error_info(&quot;ITestAtlObj&quot;),
  event_source(&quot;com&quot;),
  vi_progid(&quot;TestComAtlNet.TestAtlObj&quot;),
  progid(&quot;TestComAtlNet.TestAtlObj.1&quot;),
  version(1.0),
  uuid(&quot;8CFF83A5-6A5F-4AE7-BDB5-45E8532AC543&quot;),
  helpstring(&quot;Replace default text&quot;)
]
class ATL_NO_VTABLE <b>CTestAtlObj</b> :
...</code></pre>
  <p>producing an IDL file after compilation</p>
  <pre><code>[
 version(1.0),
 uuid(8CFF83A5-6A5F-4AE7-BDB5-45E8532AC543),
 helpstring(&quot;Replace default text&quot;)
]
#line 51 &quot;...\\testatlobj.h&quot;
coclass <b>CTestAtlObj</b> {
 interface ITestAtlObj;
 ...
};</code></pre>
  </li>
  <li>Add new method to the newly created object<br />
  <img border="0" src="Res/ComAtlVc7A.gif" width="343" height="116" /><br />
  and define parameters and result type<br />
  <img border="0" src="Res/ComAtlVc7B.gif" width="615" height="437" /></li>
  <li>Change default implementation of the newly added method:<br />
  <img border="0" src="Res/ComAtlVc7C.gif" width="274" height="140" /><br />
  <code><br />
  STDMETHODIMP CTestAtlObj::TestMethod(long lInput, long* pResult)<br />
  {<br />
  *pResult = 2 + lInput;<br />
  return S_OK;<br />
  }</code></li>
  <li>Build the project. The compiler will register your new COM exe so it could 
  be used by container application. To unregister the COM dll server use command
  <code>regsvr32 /u ComName</code>. For COM exe use <code>ComName /UnregServer</code>. 
  Also, to obtain more insight into build process, replace the command-line of 
  Post-Build Event
  <img border="0" src="Res/ComAtlVc7H.gif" width="644" height="440" /><br />
  with following script:
  <pre><b>@echo off
&quot;$(TargetPath)&quot; /RegServer
if errorlevel 1 goto ERR_LVL1
goto S_OK
:ERR_LVL1
echo Post-Build(4) : warning : $(TargetName) is not registered!
goto VCReportError
:S_OK</b></pre>
  <p>and Description with </p>
  <pre><b>Performing registration on $(TargetPath)</b></pre>
  </li>
  <li>If it is required for COM to generate some events, the connection points 
  have to be defined.
  <ol>
    <li>Add new method to the event source interface<br />
    <img border="0" src="Res/ComAtlVc7D.gif" width="328" height="453" /></li>
    <li>Also, add parameters to the method. Use COM-compatible string type for 
    the text handling.<br />
    <img border="0" src="Res/ComAtlVc7F.gif" width="420" height="213" /><br />
    In the Solution Explorer find the <i>.idl</i> file
    <a href="Src/TestComAtlNet.idl">
    <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8" /></a> 
    and compile it. The MIDL complier will generate some files required for the 
    final build.</li>
    <li>Add the new connection point to the main class, by inserting it from the 
    interface<br />
    <img border="0" src="Res/ComAtlVc7G.gif" width="316" height="206" /><br />
    Use the <i>Implement Connection Point Wizard</i> to select the interface for 
    the new connection point <a href="Src/DITestAtl7WebEvents_CP.cpp">
    <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8" /></a><br />
    <img border="0" src="Res/ComAtlVc7E.gif" width="406" height="387" /></li>
    </ol>
    </li>
    <li>Build Proxy/Stub DLL and register it. With the <i>OLE/COM Object Viewer</i> 
    tool all registered automation components could be browsed:<br />
    <img border="0" src="Res/ComAtlVc7J.gif" width="801" height="430" /></li>
    <li>To test the the COM object, create new &quot;Win32 Console Application&quot; 
    project for example.<br />
    <img border="0" src="Res/ComAtlVc7I.gif" width="531" height="157" /></li>
    <li>Insert following code in the file
    <a href="../TestComContainer/Src/main.cpp">
    <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8" /></a> 
    created by the project wizard:
    <pre><code>#include &quot;STL/KOStream.h&quot; //_tcout
//Files generated by MIDL compiler
#include &quot;TestAtlComNet.h&quot;
#include &quot;TestAtlComNet_i.c&quot; //CLSID_TestAtl7Obj
//or to load the typelib from the exe
//#import &quot;TestAtl7Com.exe&quot; no_namespace
/////////////////////////////////////////////////////////////////////////////
#ifdef _MSC_VER     /*Microsoft Visual Studio C/C++ compiler                 */
  #ifndef _CONSOLE
    #error &quot;define _CONSOLE macro in the project&quot;
  #endif
#endif

//-----------------------------------------------------------------------------
/*Test ATL COM container.
  Defines the entry point for the console application.

  Returns: EXIT_SUCCESS, which represents a value of 0, if successful. Otherwise
  a non-zero error code is returned.

  Note: uses Active Template Library (ATL);
        Microsoft Windows specific (Win32).
 */
int _tmain(int argc,      //[in] specifies how many arguments are passed to the
                          //program from the command line. The value of argc is
                          //at least one: the program name.
           TCHAR* argv[], //[in] the program arguments as an array of pointers
                          //to null-terminated strings. The first string
                          //(argv[0]) is the program name. The end of the array
                          //(argv[argc]) is indicated by a NULL pointer.
           TCHAR* envp[]  //[in] the user&#39;s environment variables as a pointer
                          //to an array of null-terminated strings. The end of
                          //the array is indicated by a NULL pointer.
                          //Note: Microsoft Windows specific (Win).
           )
{
int nRetCode = EXIT_SUCCESS;



std::_tcout &lt;&lt; &quot;Creating COM object...&quot; &lt;&lt; std::endl;
HRESULT hResult = CoInitialize(NULL); //Initialize COM
if(SUCCEEDED(hResult))
  {
  ITestAtl7Obj* pcomTest = NULL;
  hResult = CoCreateInstance( CLSID_TestAtl7Obj,
                              NULL,
                              CLSCTX_ALL, //.exe COM could run only as local
                                          //or remote out-of-process server
                              IID_ITestAtl7Obj,
                              (void**)&amp; pcomTest);

  if(SUCCEEDED(hResult))
    {
    long lResult;
    pcomTest-&gt;TestMethod(7, &amp;lResult);
    std::_tcout &lt;&lt; &quot;2 + 7 = &quot; &lt;&lt; lResult &lt;&lt; std::endl;
    pcomTest-&gt;Release();
    }
  else
    {
    std::_tcout &lt;&lt; &quot;CoCreateInstance() failed!&quot; &lt;&lt; std::endl;
    }
  }

CoUninitialize(); //Uninitialize COM

return nRetCode;
}</code></pre>
    </li>
    <li>Compile and run the test application. Expected output is:<br />
    <table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="31%">
      <tr>
        <td width="100%" bgcolor="#000000"><font color="#FFFFFF"></font>
        <pre><font color="#FFFFFF">C:\&gt;TestComContainer.exe
Creating COM object...
2 + 7 = 9
C:\&gt;</font></pre>
        <font color="#FFFFFF"></font></td>
      </tr>
    </table>
    </li>
    <li>Testing event sink
    <a href="../TestComContainer/Src/TestComWebEventHandlerRt.h">
    <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8" /></a> 
    in the single-threaded apartment model requires a message loop
    <a href="../TestComContainer/Src/TestComEvent.cpp">
    <img border="0" src="../../../../../Doc/Symbol/externS.gif" width="8" height="8" /></a> 
    with help of <code>MsgWaitForMultipleObjects</code> synchronization 
    mechanism.</li>
    <li>In order to debug the COM Server, the process have to be attached to the 
    debugger. Select <i>Debug | Processes...</i> menu item and select the 
    process in question.<br />
    <img border="0" src="Res/ComAtlVc7K.gif" width="540" height="244" /><br />
    The program type is, of course, <i>Native</i>:<br />
    <img border="0" src="Res/ComAtlVc7L.gif" width="305" height="148" /><br />
    If the code has hardcoded breakpoints (for example <code>ATLASSERT(false)</code>), 
    the debugger will interrupt the execution.<br />
    </li>
    </ol>
    <hr />
    <p><a name="Footnote1" class="Footnote" id="ID_FOOTNOTE1"><sup>1</sup></a>Active 
    Template Library is Microsoft C++ library usually used to create ActiveX and 
    other software components based on Component Object Model.<br />
    <a name="Footnote2" class="Footnote" id="ID_FOOTNOTE2"><sup>2</sup></a>Component 
    Object Model defines how an object exposes its functionality, allowing to be 
    accessed from other processes and across networks. A COM Object must support 
    the <b>IUnknown</b> interface.<br />
    <a name="Footnote3" class="Footnote" id="ID_FOOTNOTE3"><sup>3</sup></a><font size="-1">Microsoft 
    Foundation Class Library</font>. </p>
    <p><a name="200839" class="Ref">Q200839</a> Article ID:200839
    <a href="http://support.microsoft.com/kb/200839">How To Enable ActiveX 
    Control Event Handling on a Web Page</a><a></a></p>

    </body>

    </html>
